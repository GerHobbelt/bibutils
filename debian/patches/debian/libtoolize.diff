From: David Bremner <bremner@unb.ca>
Subject: [PATCH] debian/libtoolize

Use libtool to create a shared library

Signed-off-by: David Bremner <bremner@unb.ca>

---
 Makefile_start |    6 +++---
 bin/Makefile   |    2 +-
 lib/Makefile   |   27 ++++++++++++++++++++-------
 test/Makefile  |    2 +-
 4 files changed, 25 insertions(+), 12 deletions(-)

diff --git a/Makefile_start b/Makefile_start
index 7c40c1a..3ed655d 100644
--- a/Makefile_start
+++ b/Makefile_start
@@ -2,7 +2,7 @@ POSTFIX=REPLACE_POSTFIX
 CC = REPLACE_CC
 RANLIB=REPLACE_RANLIB
 INSTALLDIR=REPLACE_INSTALLDIR
-
+SOVERSION ?= 0:0:0
 VERSION=4.1
 DATE=12/21/08
 
@@ -10,8 +10,8 @@ PROGRAMS=bib2xml ris2xml end2xml endx2xml med2xml isi2xml copac2xml \
 	xml2ads xml2bib xml2end xml2isi xml2ris xml2wordbib modsclean
 
 all : FORCE
-	cd lib; make -k $(CC) -k $(RANLIB); cd ..
-	cd bin; make -k $(CC) -k VERSION="$(VERSION)" -k DATE="$(DATE)"; cd ..
+	cd lib; make -k $(RANLIB) SOVERSION=$(SOVERSION); cd ..
+	cd bin; make -k $(CC) VERSION="$(VERSION)" -k DATE="$(DATE)"; cd ..
 
 clean: FORCE
 	cd lib     ; make clean ; cd ..
diff --git a/bin/Makefile b/bin/Makefile
index c5b5f57..f3ae3a2 100644
--- a/bin/Makefile
+++ b/bin/Makefile
@@ -3,7 +3,7 @@
 #
 
 CFLAGS     = -I ../lib
-LIBDIR     = -L../lib
+LIBDIR     = -L../lib/.libs -L../lib
 PROGS      = bib2xml biblatex2xml copac2xml end2xml endx2xml isi2xml med2xml \
              ris2xml \
              xml2ads xml2bib xml2end xml2isi xml2ris xml2wordbib modsclean
diff --git a/lib/Makefile b/lib/Makefile
index 1d4ef90..5bbdcc5 100644
--- a/lib/Makefile
+++ b/lib/Makefile
@@ -1,5 +1,12 @@
-#CC = gcc -Wall 
-#RANLIB = echo
+LD=ld
+CC = gcc
+RANLIB = echo
+CFLAGS ?= -Wall -O2 -g
+SOVERSION ?= 0:0:0
+
+.SUFFIXES: .lo
+.c.lo:
+	 libtool --mode=compile $(CC) -c $(CFLAGS) -o $@ $<
 
 BIB_OBJS = bbl.o fields.o list.o name.o title.o reftypes.o
 
@@ -21,16 +28,22 @@ OUTPUT_OBJS   = bibtexout.o endout.o isiout.o modsout.o risout.o wordout.o \
 BIBUTILS_OBJS = $(SIMPLE_OBJS) $(NEWSTR_OBJS) $(CONTAIN_OBJS) \
 	$(INPUT_OBJS) $(OUTPUT_OBJS) name.o title.o bibl.o serialno.o bibutils.o
 
-all:  libbibutils.a
+BIBUTILS_LO=$(subst .o,.lo,$(BIBUTILS_OBJS))
+BIBPROGS_OBJS = bibprogs.o compiledate.o
+
+all:  libbibutils.a libbibutils.la
 
 libbibutils.a: $(BIBUTILS_OBJS)
-	ar -cr libbibutils.a $(BIBUTILS_OBJS)
-	$(RANLIB) libbibutils.a
+	ar -cr $@ $(BIBUTILS_OBJS)	
+	$(RANLIB) $@
+
+libbibutils.la: $(BIBUTILS_LO) 
+	libtool --mode=link  $(CC) -version-info $(SOVERSION) -shared -rpath /usr/lib -o $@ $(BIBUTILS_LO)
 
 clean: 
-	/bin/rm -f *.o core
+	/bin/rm -fr *.o core *.a *.la *.lo .libs
 
 realclean:
-	/bin/rm -f *.o *.a core
+	/bin/rm -rf *.o *.lo *.la *.lo *.a .libs core
 
 test:
diff --git a/test/Makefile b/test/Makefile
index c0f005b..43604dd 100644
--- a/test/Makefile
+++ b/test/Makefile
@@ -4,7 +4,7 @@
 
 CFLAGS     = -Wall -I ../lib
 LIBDIR     = -L../lib
-LIBS       = -lbibutils 
+LIBS       = -static -lbibutils
 PROGS      = newstr_test entities_test utf8_test
 
 all: $(PROGS)
-- 
tg: (7221d3c..) debian/libtoolize (depends on: master)
