From: David Bremner <bremner@unb.ca>
Subject: [PATCH] debian/libtoolize

Use libtool to create a shared library

Signed-off-by: David Bremner <bremner@unb.ca>

---
 Makefile_start |    2 +-
 bin/Makefile   |    2 +-
 lib/Makefile   |   25 ++++++++++++++++++-------
 test/Makefile  |    4 ++--
 4 files changed, 22 insertions(+), 11 deletions(-)

diff --git a/Makefile_start b/Makefile_start
index 7c40c1a..7f34098 100644
--- a/Makefile_start
+++ b/Makefile_start
@@ -10,7 +10,7 @@ PROGRAMS=bib2xml ris2xml end2xml endx2xml med2xml isi2xml copac2xml \
 	xml2ads xml2bib xml2end xml2isi xml2ris xml2wordbib modsclean
 
 all : FORCE
-	cd lib; make -k $(CC) -k $(RANLIB); cd ..
+	cd lib; make -k $(CC) -k $(RANLIB) SOVERSION=$(SOVERSION); cd ..
 	cd bin; make -k $(CC) -k VERSION="$(VERSION)" -k DATE="$(DATE)"; cd ..
 
 clean: FORCE
diff --git a/bin/Makefile b/bin/Makefile
index c5b5f57..f3ae3a2 100644
--- a/bin/Makefile
+++ b/bin/Makefile
@@ -3,7 +3,7 @@
 #
 
 CFLAGS     = -I ../lib
-LIBDIR     = -L../lib
+LIBDIR     = -L../lib/.libs -L../lib
 PROGS      = bib2xml biblatex2xml copac2xml end2xml endx2xml isi2xml med2xml \
              ris2xml \
              xml2ads xml2bib xml2end xml2isi xml2ris xml2wordbib modsclean
diff --git a/lib/Makefile b/lib/Makefile
index 1d4ef90..5f54ba8 100644
--- a/lib/Makefile
+++ b/lib/Makefile
@@ -1,5 +1,11 @@
-#CC = gcc -Wall 
-#RANLIB = echo
+LD=ld
+CC = gcc
+RANLIB = echo
+CFLAGS ?= -Wall -O2 -g
+
+.SUFFIXES: .lo
+.c.lo:
+	 libtool --mode=compile $(CC) -c $(CFLAGS) -o $@ $<
 
 BIB_OBJS = bbl.o fields.o list.o name.o title.o reftypes.o
 
@@ -21,16 +27,21 @@ OUTPUT_OBJS   = bibtexout.o endout.o isiout.o modsout.o risout.o wordout.o \
 BIBUTILS_OBJS = $(SIMPLE_OBJS) $(NEWSTR_OBJS) $(CONTAIN_OBJS) \
 	$(INPUT_OBJS) $(OUTPUT_OBJS) name.o title.o bibl.o serialno.o bibutils.o
 
-all:  libbibutils.a
+BIBUTILS_LO=$(subst .o,.lo,$(BIBUTILS_OBJS))
+BIBPROGS_OBJS = bibprogs.o compiledate.o
+
+all:  libbibutils.a 
+
+libbibutils.a: libbibutils.la
+	rm -f libbibutils.a && ln -s .libs/libbibutils.a .
 
-libbibutils.a: $(BIBUTILS_OBJS)
-	ar -cr libbibutils.a $(BIBUTILS_OBJS)
-	$(RANLIB) libbibutils.a
+libbibutils.la: $(BIBUTILS_LO)
+	libtool --mode=link  $(CC)  -version-info $(SOVERSION) -rpath /usr/lib -o libbibutils.la $(BIBUTILS_LO)
 
 clean: 
 	/bin/rm -f *.o core
 
 realclean:
-	/bin/rm -f *.o *.a core
+	/bin/rm -rf *.o *.lo *.la *.a .libs core
 
 test:
diff --git a/test/Makefile b/test/Makefile
index c0f005b..afda36f 100644
--- a/test/Makefile
+++ b/test/Makefile
@@ -3,8 +3,8 @@
 #
 
 CFLAGS     = -Wall -I ../lib
-LIBDIR     = -L../lib
-LIBS       = -lbibutils 
+LIBDIR     = -L../lib/.libs
+LIBS       = -static -lbibutils
 PROGS      = newstr_test entities_test utf8_test
 
 all: $(PROGS)
-- 
tg: (ed40d01..) debian/libtoolize (depends on: master)
